# Code Analyzer Agent - Deep analysis of entire codebase
# Creates enhancement suggestions for other agents to implement

name: üî¨ Code Analyzer Agent

on:
  schedule:
    # Run every 30 minutes for deep analysis
    - cron: "*/30 * * * *"
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: read

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - name: üõéÔ∏è Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: üîß Install Auggie CLI
        run: npm install -g @augmentcode/auggie

      - name: üî¨ Deep Codebase Analysis
        id: analyze
        env:
          AUGMENT_SESSION_AUTH: ${{ secrets.AUGMENT_SESSION_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üî¨ Starting deep codebase analysis..."
          
          # Get list of all source files
          FILES=$(find src -type f \( -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" -o -name "*.css" \) 2>/dev/null | head -50)
          
          if [ -z "$FILES" ]; then
            echo "No source files found"
            exit 0
          fi
          
          # Create analysis report
          REPORT_FILE=".github/analysis-queue.json"
          
          # Initialize or load existing queue
          if [ ! -f "$REPORT_FILE" ]; then
            echo '{"tasks":[],"lastAnalysis":"","analyzedFiles":[]}' > "$REPORT_FILE"
          fi
          
          # Pick a random file to analyze deeply
          FILE=$(echo "$FILES" | shuf -n 1)
          echo "üìÑ Analyzing: $FILE"
          
          # Read file content
          CONTENT=$(cat "$FILE" | head -200)
          
          # Create analysis prompt
          PROMPT="Analyze this file line by line and provide specific enhancement suggestions.
          
          File: $FILE
          
          Content:
          $CONTENT
          
          Provide a JSON response with this structure:
          {
            \"file\": \"$FILE\",
            \"suggestions\": [
              {
                \"line\": <line_number>,
                \"type\": \"performance|security|readability|testing|refactor\",
                \"priority\": \"high|medium|low\",
                \"current\": \"<current code snippet>\",
                \"suggested\": \"<suggested improvement>\",
                \"reason\": \"<why this improves the code>\"
              }
            ]
          }
          
          Focus on:
          1. Performance optimizations (memoization, lazy loading)
          2. Security issues (XSS, injection)
          3. Code readability improvements
          4. Missing error handling
          5. Test coverage gaps
          6. React best practices
          7. TypeScript type safety"
          
          # Run auggie for analysis
          ANALYSIS=$(auggie --print --quiet "$PROMPT" 2>&1 || echo "{}")
          
          # Save analysis to file
          echo "$ANALYSIS" > .github/latest-analysis.txt
          
          # Update the queue with new tasks
          node -e "
            const fs = require('fs');
            const queueFile = '$REPORT_FILE';
            const file = '$FILE';
            
            let queue = {tasks: [], lastAnalysis: '', analyzedFiles: []};
            try {
              queue = JSON.parse(fs.readFileSync(queueFile, 'utf8'));
            } catch(e) {}
            
            // Add file to analyzed list
            if (!queue.analyzedFiles.includes(file)) {
              queue.analyzedFiles.push(file);
            }
            
            // Update timestamp
            queue.lastAnalysis = new Date().toISOString();
            queue.lastFile = file;
            
            fs.writeFileSync(queueFile, JSON.stringify(queue, null, 2));
            console.log('Updated analysis queue');
          "
          
          echo "analysis_complete=true" >> $GITHUB_OUTPUT

      - name: üìù Create Enhancement Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            // Read the analysis
            let analysis = '';
            try {
              analysis = fs.readFileSync('.github/latest-analysis.txt', 'utf8');
            } catch(e) {
              console.log('No analysis file found');
              return;
            }
            
            if (!analysis || analysis.length < 50) {
              console.log('Analysis too short, skipping issue creation');
              return;
            }
            
            // Check for existing open analysis issues
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ai-analysis',
              per_page: 10
            });
            
            // Limit open analysis issues to 5
            if (issues.length >= 5) {
              console.log('Already have 5 open analysis issues, skipping');
              return;
            }
            
            // Create enhancement issue
            const title = `üî¨ Code Analysis: Enhancement Suggestions - ${new Date().toISOString().split('T')[0]}`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: `## üî¨ Automated Code Analysis\n\n${analysis}\n\n---\n*Generated by Code Analyzer Agent*`,
              labels: ['ai-analysis', 'enhancement', 'automated']
            });
            
            console.log('Created enhancement issue');

      - name: üì§ Commit Analysis Queue
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .github/analysis-queue.json .github/latest-analysis.txt 2>/dev/null || true
          git diff --staged --quiet || git commit -m "üî¨ Update analysis queue [skip ci]"
          git push || true

      - name: üìù Log Activity
        if: always()
        run: |
          ANALYZED="${{ steps.analyze.outputs.analysis_complete || 'false' }}"
          echo "[$(date -u +%Y-%m-%dT%H:%M:%SZ)] [ANALYZER] [RUN] Analysis complete: $ANALYZED" >> .github/agent-logs/activity.log

          # Update stats
          node -e "
            const fs = require('fs');
            const stats = JSON.parse(fs.readFileSync('.github/agent-logs/stats.json'));
            stats.agents.analyzer.runs++;
            stats.agents.analyzer.lastRun = new Date().toISOString();
            stats.totalRuns++;
            if ('$ANALYZED' === 'true') stats.filesAnalyzed++;
            stats.lastActivity = new Date().toISOString();
            fs.writeFileSync('.github/agent-logs/stats.json', JSON.stringify(stats, null, 2));
          "

          git pull --rebase || true
          git add .github/agent-logs/ || true
          git diff --staged --quiet || git commit -m "üìä Update agent logs [skip ci]"
          git push || true
