# AI Agent - Continuously modifies and improves the codebase
# Runs every hour during the day (configurable)

name: ğŸ¤– AI Agent

on:
  schedule:
    # Run every hour from 9 AM to 6 PM UTC (configurable)
    - cron: "0 9-18 * * 1-5" # Weekdays only
  workflow_dispatch: # Allow manual triggering
    inputs:
      task:
        description: "Specific task for the AI agent"
        required: false
        default: "improve"
        type: choice
        options:
          - improve
          - refactor
          - add-tests
          - fix-bugs
          - add-comments
          - optimize
          - random

permissions:
  contents: write
  pull-requests: write

env:
  NODE_VERSION: "18"

jobs:
  ai-agent:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ğŸ›ï¸ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "yarn"

      - name: ğŸ“¥ Install dependencies
        run: yarn install --frozen-lockfile

      - name: ğŸ§  Run AI Agent
        id: ai-agent
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TASK_TYPE: ${{ github.event.inputs.task || 'random' }}
        run: node .github/scripts/ai-agent.js

      - name: ğŸ“ Check for changes
        id: check-changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected!"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes made"
          fi

      - name: ğŸ”€ Create Pull Request
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ğŸ¤– AI Agent: ${{ steps.ai-agent.outputs.summary }}"
          title: "ğŸ¤– AI Agent: ${{ steps.ai-agent.outputs.summary }}"
          body: |
            ## ğŸ¤– AI Agent Automated Changes

            **Task Type:** ${{ github.event.inputs.task || 'random' }}
            **Timestamp:** ${{ github.event.repository.updated_at }}

            ### Summary
            ${{ steps.ai-agent.outputs.summary }}

            ### Changes Made
            ${{ steps.ai-agent.outputs.changes }}

            ---
            *This PR was automatically created by the AI Agent workflow.*
            *Review carefully before merging.*
          branch: ai-agent/${{ github.run_id }}
          base: main
          labels: |
            ai-generated
            automated
          reviewers: ${{ github.repository_owner }}

