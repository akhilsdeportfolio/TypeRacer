# Continuous Augment Agent - Runs every 2 hours to improve the codebase
# Uses Augment Code CLI (auggie)

name: ðŸ¤– Continuous Improvement Agent

on:
  schedule:
    # Run every 2 hours from 8 AM to 8 PM UTC on weekdays
    - cron: "0 8,10,12,14,16,18,20 * * 1-5"
  workflow_dispatch:
    inputs:
      instruction:
        description: "Custom instruction for the agent"
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

env:
  NODE_VERSION: "22"

jobs:
  improve-code:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: ðŸ›Žï¸ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ”§ Install Auggie CLI
        run: npm install -g @augmentcode/auggie

      - name: ðŸŽ² Select random improvement task
        id: task
        run: |
          TASKS=(
            "Find a React component that could be improved with better prop handling or hooks usage. Make the improvement."
            "Add or improve unit tests for an existing component or utility function."
            "Find code duplication and refactor it into a reusable function or hook."
            "Add JSDoc comments to functions that are missing documentation."
            "Find a performance optimization opportunity and implement it."
            "Improve error handling in an existing component or function."
            "Add accessibility improvements to a component."
            "Simplify complex conditional logic in any file."
          )

          # Pick a random task
          RANDOM_INDEX=$((RANDOM % ${#TASKS[@]}))
          SELECTED_TASK="${TASKS[$RANDOM_INDEX]}"

          # Use custom instruction if provided
          if [ -n "${{ github.event.inputs.instruction }}" ]; then
            SELECTED_TASK="${{ github.event.inputs.instruction }}"
          fi

          echo "instruction=$SELECTED_TASK" >> $GITHUB_OUTPUT
          echo "Selected task: $SELECTED_TASK"

      - name: ðŸ¤– Run Augment Agent
        id: auggie
        env:
          AUGMENT_SESSION_AUTH: ${{ secrets.AUGMENT_SESSION_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Running Auggie with: ${{ steps.task.outputs.instruction }}"

          # Run auggie in print mode (non-interactive)
          auggie --print --quiet "${{ steps.task.outputs.instruction }}" 2>&1 | tee auggie-output.txt || true

          # Check if files were modified
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected!"
            SUMMARY="Continuous Improvement: $(git diff --stat | tail -1)"
            echo "summary=$SUMMARY" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes made"
          fi

      - name: ðŸ”€ Create Pull Request
        if: steps.auggie.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ðŸ¤– AI: ${{ steps.auggie.outputs.summary }}"
          title: "ðŸ¤– AI: Continuous Improvement"
          body: |
            ## ðŸ¤– Continuous Improvement

            **Task:** ${{ steps.task.outputs.instruction }}
            **Run ID:** ${{ github.run_id }}

            ### Summary
            ${{ steps.auggie.outputs.summary }}

            ---
            *Powered by [Augment Code](https://augmentcode.com) CLI.*
          branch: augment-continuous/${{ github.run_id }}
          base: main
          labels: |
            ai-generated
            continuous-improvement
          reviewers: ${{ github.repository_owner }}

