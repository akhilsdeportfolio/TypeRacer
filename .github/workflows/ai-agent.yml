# Augment AI Agent - Continuously modifies and improves the codebase
# Uses official Augment Code CLI (auggie)
# Coordinated by Agent Coordinator - don't run on schedule, triggered by coordinator

name: ðŸ¤– Augment AI Agent

on:
  workflow_dispatch: # Triggered by coordinator or manually
    inputs:
      instruction:
        description: "Custom instruction for the AI agent"
        required: false
        default: "Review the codebase and make one small improvement to code quality, tests, or documentation. Focus on a single file."
        type: string
      task_type:
        description: "Type of task to perform"
        required: false
        default: "random"
        type: choice
        options:
          - random
          - improve
          - refactor
          - add-tests
          - fix-bugs
          - add-comments
          - optimize
          - implement-analysis

permissions:
  contents: write
  pull-requests: write
  issues: read

env:
  NODE_VERSION: "22"

jobs:
  augment-agent:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ðŸ›Žï¸ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ”§ Install Auggie CLI
        run: npm install -g @augmentcode/auggie

      - name: ðŸ§  Run Augment Agent
        id: auggie
        env:
          AUGMENT_SESSION_AUTH: ${{ secrets.AUGMENT_SESSION_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Build the instruction based on task type
          TASK_TYPE="${{ github.event.inputs.task_type || 'random' }}"

          # If random, pick a random task
          if [ "$TASK_TYPE" = "random" ]; then
            TASKS=("improve" "refactor" "add-tests" "fix-bugs" "add-comments" "optimize")
            TASK_TYPE=${TASKS[$RANDOM % ${#TASKS[@]}]}
            echo "ðŸŽ² Random task selected: $TASK_TYPE"
          fi

          case $TASK_TYPE in
            improve)
              INSTRUCTION="Review the codebase and improve code quality, readability, and maintainability. Make a small, focused change to one file."
              ;;
            refactor)
              INSTRUCTION="Find code that could benefit from refactoring. Apply React best practices, extract reusable hooks, or simplify complex logic."
              ;;
            add-tests)
              INSTRUCTION="Find a component or utility that lacks test coverage. Add comprehensive unit tests using Jest and React Testing Library."
              ;;
            fix-bugs)
              INSTRUCTION="Review the codebase for potential bugs like null checks, race conditions, or incorrect state handling. Fix one issue."
              ;;
            add-comments)
              INSTRUCTION="Find code that would benefit from better documentation. Add JSDoc comments, inline explanations, or TODO markers."
              ;;
            optimize)
              INSTRUCTION="Find performance optimization opportunities. Apply memoization, lazy loading, or algorithm improvements."
              ;;
            implement-analysis)
              INSTRUCTION="Check the .github/analysis-queue.json file for pending enhancement tasks. Implement the highest priority suggestion from the analysis."
              ;;
            *)
              INSTRUCTION="${{ github.event.inputs.instruction }}"
              ;;
          esac

          echo "task_type=$TASK_TYPE" >> $GITHUB_OUTPUT

          echo "Running Auggie with instruction: $INSTRUCTION"

          # Run auggie in print mode (non-interactive)
          auggie --print --quiet "$INSTRUCTION" 2>&1 | tee auggie-output.txt || true

          # Check if files were modified
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected!"

            # Capture summary
            SUMMARY="$TASK_TYPE: $(git diff --stat | tail -1)"
            echo "summary=$SUMMARY" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes made"
          fi

      - name: ðŸ”€ Create Pull Request
        if: steps.auggie.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ðŸ¤– Augment Agent: ${{ steps.auggie.outputs.summary }}"
          title: "ðŸ¤– Augment Agent: ${{ steps.auggie.outputs.task_type || 'improve' }}"
          body: |
            ## ðŸ¤– Augment AI Agent Automated Changes

            **Task Type:** ${{ github.event.inputs.task_type || 'improve' }}
            **Run ID:** ${{ github.run_id }}

            ### Summary
            ${{ steps.auggie.outputs.summary }}

            ### Auggie Output
            ```
            $(cat auggie-output.txt 2>/dev/null || echo "No output captured")
            ```

            ---
            *This PR was automatically created by the Augment AI Agent.*
            *Powered by [Augment Code](https://augmentcode.com) CLI.*
            *Review carefully before merging.*
          branch: augment-agent/${{ github.run_id }}
          base: main
          labels: |
            ai-generated
            augment
          reviewers: ${{ github.repository_owner }}

      - name: ðŸ“ Log Activity
        if: always()
        run: |
          TASK="${{ steps.auggie.outputs.task_type || 'unknown' }}"
          CHANGES="${{ steps.auggie.outputs.has_changes || 'false' }}"
          echo "[$(date -u +%Y-%m-%dT%H:%M:%SZ)] [AI-AGENT] [RUN] Task: $TASK, Changes: $CHANGES" >> .github/agent-logs/activity.log

          # Update stats
          node -e "
            const fs = require('fs');
            const stats = JSON.parse(fs.readFileSync('.github/agent-logs/stats.json'));
            stats.agents.aiAgent.runs++;
            stats.agents.aiAgent.lastRun = new Date().toISOString();
            stats.totalRuns++;
            if ('$CHANGES' === 'true') stats.prsCreated++;
            stats.lastActivity = new Date().toISOString();
            fs.writeFileSync('.github/agent-logs/stats.json', JSON.stringify(stats, null, 2));
          "

          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git pull --rebase || true
          git add .github/agent-logs/ || true
          git diff --staged --quiet || git commit -m "ðŸ“Š Update agent logs [skip ci]"
          git push || true
