# Auto-Merge Agent - Merges PRs created by the AI agents
# Runs frequently to keep the merge queue moving

name: ðŸ”€ Auto-Merge Agent

on:
  schedule:
    # Run every 5 minutes, 24/7
    - cron: "*/5 * * * *"
  workflow_dispatch: # Allow manual triggering
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Find and Merge AI PRs
        id: merge
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            console.log('ðŸ” Looking for AI-created PRs to merge...');
            
            // Get all open PRs
            const { data: pulls } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              sort: 'created',
              direction: 'asc' // Oldest first
            });
            
            console.log(`Found ${pulls.length} open PRs`);
            
            // Filter for AI-created PRs (by github-actions bot)
            const aiPRs = pulls.filter(pr => 
              pr.user.login === 'github-actions[bot]' &&
              (pr.title.includes('ðŸ¤–') || pr.title.includes('AI') || pr.title.includes('Augment'))
            );
            
            console.log(`Found ${aiPRs.length} AI-created PRs`);
            
            if (aiPRs.length === 0) {
              console.log('âœ… No AI PRs to merge');
              return;
            }
            
            // Process each AI PR
            for (const pr of aiPRs) {
              console.log(`\nðŸ“‹ Processing PR #${pr.number}: ${pr.title}`);
              
              try {
                // Check if PR is mergeable
                const { data: prDetails } = await github.rest.pulls.get({
                  owner,
                  repo,
                  pull_number: pr.number
                });
                
                if (prDetails.mergeable === false) {
                  console.log(`âš ï¸ PR #${pr.number} has conflicts, skipping`);
                  continue;
                }
                
                if (prDetails.mergeable === null) {
                  console.log(`â³ PR #${pr.number} mergeability unknown, will retry later`);
                  continue;
                }
                
                // Check CI status
                const { data: checks } = await github.rest.checks.listForRef({
                  owner,
                  repo,
                  ref: pr.head.sha
                });
                
                const failedChecks = checks.check_runs.filter(
                  check => check.conclusion === 'failure' || check.conclusion === 'cancelled'
                );
                
                const pendingChecks = checks.check_runs.filter(
                  check => check.status === 'in_progress' || check.status === 'queued'
                );
                
                if (failedChecks.length > 0) {
                  console.log(`âŒ PR #${pr.number} has ${failedChecks.length} failed checks, closing PR`);
                  
                  // Close the PR with a comment
                  await github.rest.issues.createComment({
                    owner,
                    repo,
                    issue_number: pr.number,
                    body: 'âŒ **Auto-closed**: This PR failed CI checks and cannot be merged.\n\nFailed checks:\n' + 
                          failedChecks.map(c => `- ${c.name}: ${c.conclusion}`).join('\n')
                  });
                  
                  await github.rest.pulls.update({
                    owner,
                    repo,
                    pull_number: pr.number,
                    state: 'closed'
                  });
                  continue;
                }
                
                if (pendingChecks.length > 0) {
                  console.log(`â³ PR #${pr.number} has ${pendingChecks.length} pending checks, will retry later`);
                  continue;
                }
                
                // All checks passed, merge the PR!
                console.log(`âœ… Merging PR #${pr.number}...`);
                
                await github.rest.pulls.merge({
                  owner,
                  repo,
                  pull_number: pr.number,
                  merge_method: 'squash',
                  commit_title: `${pr.title} (#${pr.number})`
                });
                
                console.log(`ðŸŽ‰ Successfully merged PR #${pr.number}`);
                
                // Delete the branch
                try {
                  await github.rest.git.deleteRef({
                    owner,
                    repo,
                    ref: `heads/${pr.head.ref}`
                  });
                  console.log(`ðŸ—‘ï¸ Deleted branch: ${pr.head.ref}`);
                } catch (e) {
                  console.log(`âš ï¸ Could not delete branch: ${e.message}`);
                }
                
                // Only merge one PR per run to avoid conflicts
                console.log('â¸ï¸ Stopping after one merge to let CI run on main');

                // Set output for logging
                core.setOutput('merged_pr', pr.number);
                break;

              } catch (error) {
                console.log(`âŒ Error processing PR #${pr.number}: ${error.message}`);
              }
            }

            core.setOutput('ai_prs_count', aiPRs.length);

      - name: ðŸ“ Log Activity
        if: always()
        run: |
          echo "[$(date -u +%Y-%m-%dT%H:%M:%SZ)] [AUTO-MERGE] [RUN] Checked PRs, count: ${{ steps.merge.outputs.ai_prs_count || '0' }}" >> .github/agent-logs/activity.log

          # Update stats
          node -e "
            const fs = require('fs');
            const stats = JSON.parse(fs.readFileSync('.github/agent-logs/stats.json'));
            stats.agents.autoMerge.runs++;
            stats.agents.autoMerge.lastRun = new Date().toISOString();
            stats.totalRuns++;
            stats.lastActivity = new Date().toISOString();
            fs.writeFileSync('.github/agent-logs/stats.json', JSON.stringify(stats, null, 2));
          "

          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git pull --rebase || true
          git add .github/agent-logs/ || true
          git diff --staged --quiet || git commit -m "ðŸ“Š Update agent logs [skip ci]"
          git push || true
